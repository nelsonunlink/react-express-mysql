# MySQL Deployment - Single replica database instance
# Note: For production, consider using MySQL Operator or managed database service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql
  labels:
    app: mysql
spec:
  # Single replica - MySQL doesn't support multi-write by default
  replicas: 1
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 3306
          name: mysql
        env:
        # Password from Kubernetes Secret for security
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: mysql-root-password
        # Database to create on startup
        - name: MYSQL_DATABASE
          value: "testdb"
        # Readiness Probe: Determines when pod can receive traffic
        # MySQL takes time to initialize on first start
        readinessProbe:
          tcpSocket:
            port: 3306
          initialDelaySeconds: 15    # Wait 15s before first check
          periodSeconds: 10          # Check every 10s
          timeoutSeconds: 5          # Probe timeout
          failureThreshold: 6        # Allow 6 failures (60s total)
        # Liveness Probe: Determines if pod is healthy and should restart
        livenessProbe:
          tcpSocket:
            port: 3306
          initialDelaySeconds: 60    # MySQL needs time to fully start
          periodSeconds: 20          # Check every 20s
          timeoutSeconds: 5
          failureThreshold: 3        # Restart after 3 failures
        # Resource Management
        resources:
          requests:
            # Minimum guaranteed resources
            cpu: "250m"              # 0.25 CPU cores
            memory: "512Mi"
          limits:
            # Maximum allowed resources
            cpu: "500m"              # 0.5 CPU cores
            memory: "1Gi"
        volumeMounts:
        # Persistent data storage
        - name: mysql-storage
          mountPath: /var/lib/mysql
        # Mount init script to run on first startup
        - name: mysql-init
          mountPath: /docker-entrypoint-initdb.d
      volumes:
      # Persistent Volume Claim for data persistence
      - name: mysql-storage
        persistentVolumeClaim:
          claimName: mysql-pvc
      # Init script ConfigMap volume
      - name: mysql-init
        configMap:
          name: mysql-init-script